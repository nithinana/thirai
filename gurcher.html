<!DOCTYPE html>
<html lang="en">
<head>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HKV7GQ766F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HKV7GQ766F');
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  // CAPTURE ORIGINAL URL BEFORE REWRITING
  const ORIGINAL_SEARCH_PARAMS = window.location.search;

  (function() {
    const urlParams = new URLSearchParams(window.location.search);
    const movieCode = urlParams.get('film');

    if (movieCode) {
      const formID = "1FAIpQLSeg_JCKjxY_5W977CB5-hFqLpemBCw_o477qV-6vlDKFFJ_VQ";
      const entryID = "entry.132457679"; 

      const finalURL = `https://docs.google.com/forms/d/e/${formID}/formResponse?${entryID}=${encodeURIComponent(movieCode)}&submit=Submit`;

      if (navigator.sendBeacon) {
        navigator.sendBeacon(finalURL);
      } else {
        fetch(finalURL, { mode: 'no-cors' });
      }
      console.log("Tracking sent: " + movieCode);
    }
  })();
</script>
 
<script>
    (function() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const movieUrl = urlParams.get('url');
            let needsRewrite = false;

            if (movieUrl) {
                needsRewrite = true;
                const movieCodeMatch = movieUrl.match(/\/watch\/([a-zA-Z0-9]+)/);

                if (movieCodeMatch && movieCodeMatch[1]) {
                    const movieCode = movieCodeMatch[1];
                    urlParams.set('film', movieCode);
                    urlParams.delete('url');
                }
            }
            
            if (urlParams.has('title')) {
                needsRewrite = true;
                urlParams.delete('title');
            }

            if(needsRewrite) {
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState({ path: newUrl }, '', newUrl);
                console.log('URL has been rewritten.');
            }

        } catch (error) {
            console.error('Error rewriting URL:', error);
        }
    })();
</script>

    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <meta name="screen-orientation" content="landscape">
    <link rel="manifest" href="/manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Thirai">

<link rel="apple-touch-icon" href="/static/ios/icon-192x192.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/ios/icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/ios/icon-180x180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/static/ios/icon-167x167.png">

<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-750x1334.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2208.png">
<link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1125x2436.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="/static/splash/launch-828x1792.png">
<link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1242x2688.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1080x2340.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1170x2532.png">
<link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/static/splash/launch-1284x2778.png">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Thirai</title>
    <link rel="icon" type="image/png" href="/static/favicon.png"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Backdrop Blur Effect */
        #modalBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 999;
            display: none;
        }

        .video-player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        #moviePlayer {
            transform: scale(1);
            transform-origin: center center;
            transition: transform 0.3s ease-in-out;
            position: relative;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            controls: none;
            z-index: 1;
        }

        .video-player-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            controls: none;
        }

        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        video::-moz-range-track { background: transparent; }
        video::-moz-range-thumb { background: transparent; }

        .custom-controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            pointer-events: none;
        }

        .custom-controls-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .top-controls {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 1.5rem 1rem;
            box-sizing: border-box;
        }

        .movie-title-display {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
            margin: 0 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
        }

        .center-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .bottom-controls {
            width: 100%;
            padding: 1rem 1.5rem 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2.2rem;
            cursor: pointer;
            padding: 0.8rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            -webkit-tap-highlight-color: transparent;
        }

        .control-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        #playPauseButton {
            font-size: 3.5rem;
            padding: 1.2rem;
        }

        .progress-bar-container {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: grab;
            position: relative;
            margin: 0 1rem;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #0d6efd;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .progress-bar-handle {
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            display: none;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            transition: transform 0.1s ease;
        }
        .progress-bar-container:hover .progress-bar-handle,
        .progress-bar-container.dragging .progress-bar-handle {
            display: block;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .time-display {
            color: white;
            font-size: 1rem;
            white-space: nowrap;
            order: 2;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        .time-display:hover {
            background: rgba(255,255,255,0.1);
        }

        .progress-bar-container {
            order: 1;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
            color: white;
            border-width: 0.25em;
            vertical-align: middle;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            border-right-color: transparent;
            display: inline-block;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .top-button {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 0.7rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            -webkit-tap-highlight-color: transparent;
        }
        .top-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .top-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        #fullscreenButton {
            background: transparent;
            box-shadow: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            order: 10;
        }

        #fullscreenButton:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .volume-container {
            display: flex;
            align-items: center;
            order: 4;
            position: relative;
        }

        #volumeButton {
            background: transparent;
            box-shadow: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #volumeButton:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 0px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            opacity: 0;
            transition: width 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .volume-container:hover .volume-slider,
        .volume-slider:active,
        .volume-slider:focus {
            width: 70px;
            opacity: 1;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
        }

        /* --- WATCH PARTY UI STYLES --- */
        #partyModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #121212;
            padding: 1.5rem;
            border-radius: 16px;
            z-index: 1000;
            display: none;
            color: white;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            width: 320px;
            max-width: 90vw;
        }

        .close-modal-x {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.4rem;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-modal-x:hover {
            color: white;
        }

        .party-choice-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .choice-btn {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #333;
            padding: 20px 10px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .choice-btn i { font-size: 1.5rem; color: #0d6efd; }
        .choice-btn:hover { background: #252525; border-color: #0d6efd; }

        .party-form { display: none; text-align: left; }
        .party-form label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }

        #partyModal input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .modal-action-btn {
            width: 100%;
            padding: 12px;
            background: #0d6efd;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .modal-action-btn.secondary {
            background: #444;
        }

        .modal-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .user-list-container {
            margin: 15px 0;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            -webkit-user-select: text;
            user-select: text;
            display: none; /* Hidden by default */
        }

        .user-item {
            font-size: 0.85rem;
            padding: 6px 0;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .user-item:last-child { border-bottom: none; }
        
        .user-info-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-info-left i { color: #0d6efd; font-size: 0.7rem; }

        #qrcode {
            background: white;
            padding: 10px;
            display: inline-block;
            margin: 10px 0;
            border-radius: 8px;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #888;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Allow host to copy text */
        #displayCode {
            -webkit-user-select: text;
            user-select: text;
            font-weight: bold;
            color: #0d6efd;
        }
        
        /* Lobby specific styles */
        #lobbyScreen {
            display: none;
            text-align: center;
        }
        #lobbyPoster {
            width: 120px;
            border-radius: 8px;
            margin-bottom: 15px; /* Added spacing */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        #lobbyStatus {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
            display: block;
        }
        .copy-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 5px;
        }
        .copy-btn {
            flex: 1;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .copy-btn:hover { background: #333; }
        .copy-btn i { margin-right: 5px; }

        /* Internal Toast Popup */
        #thiraiToast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #0d6efd;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }
        #thiraiToast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Party Ended Modal */
        #partyEndedModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #121212;
            padding: 2rem;
            border-radius: 20px;
            z-index: 2000;
            display: none;
            color: white;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            width: 350px;
            max-width: 85vw;
        }
        
        #partyEndedModal .close-ended-x {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.4rem;
            color: #888;
            cursor: pointer;
        }
        #partyEndedModal .close-ended-x:hover { color: white; }

        #partyEndedModal h2 { margin-top: 0; color: #0d6efd; font-size: 1.2rem; }
        #partyEndedModal p { color: #ccc; margin: 15px 0 25px; line-height: 1.4; font-size: 0.9rem; }

    </style>
</head>
<body>
    <div id="modalBackdrop"></div>
    <div id="thiraiToast"><i class="bi bi-crown-fill"></i> <span id="toastMsg">You are now a host!</span></div>

    <div id="partyEndedModal">
        <i class="bi bi-x-lg close-ended-x" onclick="closeEndedModal()"></i>
        <i class="bi bi-info-circle-fill" style="font-size: 3rem; color: #0d6efd; display: block; margin-bottom: 15px;"></i>
        <h2 id="endedTitle">User has ended session</h2>
        <p>You may now control video playback.</p>
        <button class="modal-action-btn" onclick="closeEndedModal()">Close</button>
    </div>

    <div class="video-player-wrapper" id="videoPlayerWrapper">
        <video id="moviePlayer" playsinline webkit-playsinline preload="auto" autoplay></video>

        <div class="custom-controls-overlay" id="customControlsOverlay">
            <div class="top-controls">
                <button id="backButton" class="top-button">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <div class="movie-title-display" id="movieTitleDisplay">Thirai</div>

                <button id="partyToggleBtn" class="top-button" style="display: none;">
                    <i class="bi bi-people-fill"></i>
                </button>

                <a href="#" id="downloadButton" download="Thirai.mp4" class="top-button" style="display: none;">
                    <i class="bi bi-download"></i>
                </a>
                <button id="magnificationButton" class="top-button">
                    <i class="bi bi-zoom-in"></i> </button>
                <button id="castButton" class="top-button" style="display: none;">
                    <i class="bi bi-cast"></i>
                </button>
            </div>

            <div class="center-controls">
                <button id="rewindButton" class="control-button">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
                <button id="playPauseButton" class="control-button">
                    <i class="bi bi-play-fill"></i>
                    <div class="spinner-border" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </button>
                <button id="forwardButton" class="control-button">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>

            <div class="bottom-controls">
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-bar-handle" id="progressBarHandle"></div>
                </div>
                <span class="time-display" id="timeDisplay" title="Click to change format">00:00 / 00:00</span>
                
                <div class="volume-container">
                    <button id="volumeButton">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.05" value="1">
                </div>
                <button id="fullscreenButton" class="control-button">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="partyModal">
        <i class="bi bi-x-lg close-modal-x" id="closePartyX"></i>
        <h3 style="margin-top:0" id="partyHeader">Watch Party</h3>
        
        <div id="selectionScreen">
            <div class="party-choice-container">
                <button class="choice-btn" id="chooseHost">
                    <i class="bi bi-broadcast"></i>
                    <span>Host</span>
                </button>
                <button class="choice-btn" id="chooseJoin">
                    <i class="bi bi-door-open"></i>
                    <span>Join</span>
                </button>
            </div>
        </div>

        <div id="hostSetup" class="party-form">
            <label>Display Name</label>
            <input type="text" id="hostName" placeholder="Your Name" value="Host">
            <button class="modal-action-btn" id="startHostBtn">Create Room</button>
            <span class="back-link" onclick="resetModal()">Back</span>
        </div>

        <div id="joinSetup" class="party-form">
            <label>Display Name</label>
            <input type="text" id="joinName" placeholder="Your Name" value="Guest">
            <label>Room Code</label>
            <input type="text" id="joinCode" placeholder="Enter Code">
            <button class="modal-action-btn" id="startJoinBtn">Join Party</button>
            <span class="back-link" onclick="resetModal()">Back</span>
        </div>

        <div id="activeHostInfo" class="party-form" style="text-align: center;">
            <p style="margin-bottom: 5px;">Room Code: <span id="displayCode"></span></p>
            <div id="qrcode"></div>
            
            <div class="copy-row">
                <button class="copy-btn" id="copyCodeBtn"><i class="bi bi-clipboard"></i> Code</button>
                <button class="copy-btn" id="copyLinkBtn"><i class="bi bi-link-45deg"></i> Link</button>
            </div>

            <div class="user-list-container" id="hostUserList"></div>
            <button class="modal-action-btn" style="background:#dc3545; margin-top: 15px;" id="endPartyBtn">End Party</button>
        </div>

        <div id="lobbyScreen">
            <img id="lobbyPoster" src="" alt="Movie Poster">
            <span id="lobbyStatus">Waiting for host...</span>
            
            <div class="user-list-container" id="lobbyUserList"></div>
            
            <div class="copy-row" style="margin-bottom: 10px;">
                <button class="copy-btn" id="lobbyCopyCodeBtn"><i class="bi bi-clipboard"></i> Copy Code</button>
                <button class="copy-btn" id="lobbyCopyLinkBtn"><i class="bi bi-link-45deg"></i> Copy Link</button>
            </div>

            <button class="modal-action-btn secondary" id="leavePartyBtn">Leave Party</button>
        </div>
    </div>

    <script>
        const moviePlayer = document.getElementById('moviePlayer');
        const customControlsOverlay = document.getElementById('customControlsOverlay');
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = playPauseButton.querySelector('i');
        const loadingSpinner = playPauseButton.querySelector('.spinner-border');
        const rewindButton = document.getElementById('rewindButton');
        const forwardButton = document.getElementById('forwardButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressBarHandle = document.getElementById('progressBarHandle');
        const timeDisplay = document.getElementById('timeDisplay');
        const backButton = document.getElementById('backButton');
        const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const fullscreenIcon = fullscreenButton.querySelector('i');
        const downloadButton = document.getElementById('downloadButton');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const magnificationButton = document.getElementById('magnificationButton');
        const magnificationIcon = magnificationButton.querySelector('i');
        const castButton = document.getElementById('castButton');
        const volumeButton = document.getElementById('volumeButton');
        const volumeIcon = volumeButton.querySelector('i');
        const volumeSlider = document.getElementById('volumeSlider');

        // Watch Party Elements
        const partyToggleBtn = document.getElementById('partyToggleBtn');
        const partyModal = document.getElementById('partyModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const closePartyX = document.getElementById('closePartyX');
        const selectionScreen = document.getElementById('selectionScreen');
        const hostSetup = document.getElementById('hostSetup');
        const joinSetup = document.getElementById('joinSetup');
        const activeHostInfo = document.getElementById('activeHostInfo');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const lobbyPoster = document.getElementById('lobbyPoster');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const lobbyUserList = document.getElementById('lobbyUserList');

        let zoomLevel = 1;
        let lastVolume = 1;
        let isDraggingProgressBar = false;
        let controlsTimeout;
        const FADE_TIMEOUT_SECONDS = 7;
        let lastTapTime = 0;
        const DOUBLE_TAP_THRESHOLD_MS = 300;
        const SEEK_TIME = 10;
        let movieKey;
        let movieMeta = {}; 
        let desiredPartyState = 'pause'; 
        let isBuffering = false;

        // Timestamp Format Logic
        let timeFormatMode = 0; // 0: Rem, 1: Cur/Tot
        timeDisplay.onclick = (e) => {
            e.stopPropagation(); 
            timeFormatMode = (timeFormatMode + 1) % 2; // Removed 3rd option
            updateProgressBar();
        };

        // Watch Party Variables
        let socket;
        let isHost = false;
        let currentRoomId = null;
        let hostNickname = "Host";
        let hostSyncInterval = null; // HEARTBEAT FOR HOST
        const SERVER_URL = "https://watchpartybackend-b5a2.onrender.com"; 

        // --- WATCH PARTY INITIALIZATION ---
        try {
            socket = io(SERVER_URL);
            socket.on('connect', () => {
                partyToggleBtn.style.display = 'flex';
            });
            
            socket.on('error', (msg) => {
                if(msg === 'Room not found') {
                    showInternalToast("Room not found! Check code.");
                    joinBtn.disabled = false;
                    joinBtn.innerText = 'Join Party';
                    isHost = false;
                    currentRoomId = null;
                    resetModal();
                }
            });

        } catch (e) { console.log("Socket server unavailable"); }

        window.addEventListener('beforeunload', () => {
            if(socket) socket.disconnect();
        });

        partyToggleBtn.onclick = () => { 
            partyModal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        };

        const isJoinLink = new URLSearchParams(window.location.search).has('join');
        if (isJoinLink) {
            closePartyX.style.display = 'none';
        }

        closePartyX.onclick = () => {
            partyModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        };

        modalBackdrop.onclick = () => {
            if (!isJoinLink || (isJoinLink && currentRoomId)) {
                partyModal.style.display = 'none';
                modalBackdrop.style.display = 'none';
            }
        }

        function resetModal() {
            selectionScreen.style.display = 'block';
            hostSetup.style.display = 'none';
            joinSetup.style.display = 'none';
            activeHostInfo.style.display = 'none';
            lobbyScreen.style.display = 'none';
            resetJoinUI();
        }

        document.getElementById('chooseHost').onclick = () => {
            selectionScreen.style.display = 'none';
            hostSetup.style.display = 'block';
        };

        document.getElementById('chooseJoin').onclick = () => {
            selectionScreen.style.display = 'none';
            joinSetup.style.display = 'block';
        };

        async function copyToClipboard(text, element) {
            try {
                await navigator.clipboard.writeText(text);
                const originalHtml = element.innerHTML;
                element.innerHTML = '<i class="bi bi-check"></i> Copied';
                setTimeout(() => {
                    element.innerHTML = originalHtml;
                }, 1500);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }

function getJoinLink(code) {
    // This creates the clean format: https://yourdomain.com/join?code=ABCDEF
    return window.location.origin + '/join?code=' + code;
}

        document.getElementById('copyCodeBtn').onclick = (e) => copyToClipboard(currentRoomId, e.currentTarget);
        document.getElementById('copyLinkBtn').onclick = (e) => copyToClipboard(getJoinLink(currentRoomId), e.currentTarget);
        document.getElementById('lobbyCopyCodeBtn').onclick = (e) => copyToClipboard(currentRoomId, e.currentTarget);
        document.getElementById('lobbyCopyLinkBtn').onclick = (e) => copyToClipboard(getJoinLink(currentRoomId), e.currentTarget);

function generateHostUI(roomId) {
    document.getElementById('displayCode').innerText = roomId;
    document.getElementById('qrcode').innerHTML = "";
    
    // This uses the updated getJoinLink function above
    new QRCode(document.getElementById('qrcode'), {
        text: getJoinLink(roomId),
        width: 128,
        height: 128
    });
}

        function showInternalToast(msg) {
            const toast = document.getElementById('thiraiToast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Hosting Logic
        document.getElementById('startHostBtn').onclick = () => {
            const name = document.getElementById('hostName').value || "Host";
            isHost = true;
            hostNickname = name;
            currentRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            socket.emit('create-room', {
                roomId: currentRoomId,
                hostName: name,
                movieUrl: ORIGINAL_SEARCH_PARAMS
            });

            generateHostUI(currentRoomId);
            hostSetup.style.display = 'none';
            activeHostInfo.style.display = 'block';
            
            document.getElementById('partyHeader').innerText = movieMeta.title || "Watch Party";

            // No movie reload on host start - just sync current state
            updateControlsState();
            startHostHeartbeat();
        };

        // Joining Logic
        const joinBtn = document.getElementById('startJoinBtn');
        
        function resetJoinUI() {
            joinBtn.disabled = false;
            joinBtn.innerText = 'Join Party';
        }

joinBtn.onclick = () => {
            const name = document.getElementById('joinName').value || "Guest";
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if(!code) return;

            joinBtn.disabled = true;
            joinBtn.innerText = 'Joining...';

            isHost = false;
            currentRoomId = code;
            socket.emit('join-room', { roomId: currentRoomId, userName: name });
        };

        socket.on('joined-room', (data) => {
            const hostParams = new URLSearchParams(data.movieUrl);
            const myParams = new URLSearchParams(window.location.search);
            
            if(hostParams.get('film') !== myParams.get('film')) {
                window.location.href = window.location.pathname + data.movieUrl + "&join=" + currentRoomId;
                return;
            }

            joinSetup.style.display = 'none';
            lobbyScreen.style.display = 'block';
            partyModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            closePartyX.style.display = 'block';
            
            document.getElementById('partyHeader').innerText = movieMeta.title || "Movie Lobby";

            if(data.isHost) isHost = true;
            desiredPartyState = data.state;
            
            updateControlsState();
            
            fetchMovieSource().then(() => {
                 const title = movieMeta.title || "Unknown Movie";
                 document.getElementById('partyHeader').innerText = title;
                 if(movieMeta.img) {
                    lobbyPoster.src = movieMeta.img;
                    lobbyPoster.style.display = 'inline-block';
                 }
                 else lobbyPoster.style.display = 'none';

                 lobbyStatus.textContent = "Waiting for sync...";
            });
        });

        socket.on('user-list', (users) => {
            // Filter out Preview_User
            users = users.filter(u => u && u.name !== 'Preview_User');
            const hostList = document.getElementById('hostUserList');
            const guestList = document.getElementById('lobbyUserList');
            
            // Show/Hide container based on user count
            if (users.length > 0) {
                hostList.style.display = 'block';
                guestList.style.display = 'block';
            } else {
                hostList.style.display = 'none';
                guestList.style.display = 'none';
            }

            hostList.innerHTML = '';
            guestList.innerHTML = '';

            if (isHost && socket) {
                const state = moviePlayer.paused ? (isBuffering ? 'buffering' : 'pause') : 'play';
                socket.emit('sync-video', { roomId: currentRoomId, state: state, time: moviePlayer.currentTime });
            }

            const userItems = users.map(user => {
                let label = '';
                if(user.isHost) {
                    label = '<span style="color: #ffc107; font-size: 0.6rem; margin-left:5px;">(HOST)</span>';
                    hostNickname = user.name;
                }
                return `
                <div class="user-item">
                    <div class="user-info-left">
                        <i class="bi bi-person-fill"></i>
                        <span>${user.name} ${user.id === socket.id ? '(You)' : ''} ${label}</span>
                    </div>
                </div>
            `}).join('');

            hostList.innerHTML = userItems;
            guestList.innerHTML = userItems;
        });

        function updateControlsState() {
            if(currentRoomId && !isHost) {
                playPauseButton.disabled = true;
                rewindButton.disabled = true;
                forwardButton.disabled = true;
                progressBarContainer.style.pointerEvents = 'none';
            } else {
                playPauseButton.disabled = false;
                rewindButton.disabled = false;
                forwardButton.disabled = false;
                progressBarContainer.style.pointerEvents = 'auto';
            }
        }

        socket.on('video-update', (data) => {
            if(!isHost) {
                desiredPartyState = data.state; 

                if(data.state === 'buffering') {
                    lobbyStatus.textContent = "Host is buffering...";
                    moviePlayer.pause();
                } else if(data.state === 'play') {
                    lobbyStatus.textContent = "Playing Now";
                    const drift = Math.abs(moviePlayer.currentTime - data.time);
                    if (drift > 0.5) {
                        moviePlayer.currentTime = data.time;
                    }
                    if(moviePlayer.paused) {
                        moviePlayer.play().catch(() => { 
                            lobbyStatus.textContent = "Interaction required to sync";
                        });
                    }
                } else {
                    lobbyStatus.textContent = "Paused at " + formatTime(data.time);
                    if (Math.abs(moviePlayer.currentTime - data.time) > 0.1) {
                         moviePlayer.currentTime = data.time;
                    }
                    moviePlayer.pause();
                }
            }
        });

        socket.on('party-ended', () => {
            
            resetJoinUI();
            if (socket) socket.disconnect();
            
            // Clean up state immediately so controls work
            currentRoomId = null;
            isHost = false;
            updateControlsState();
            
            // Hide the active lobby modal
            partyModal.style.display = 'none';
            
            // Reset URL (remove ?join=...) immediately to prevent reload/join loops
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('join');
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);

            // Reset modal internal UI so next open shows Host/Join
            resetModal();

            // Show the "Ended" modal and keep backdrop
            modalBackdrop.style.display = 'block'; 
            document.getElementById('endedTitle').innerText = `${hostNickname} has ended the party`;
            document.getElementById('partyEndedModal').style.display = 'block';
        });

        function closeEndedModal() {
            document.getElementById('partyEndedModal').style.display = 'none';
            modalBackdrop.style.display = 'none';
        }

        document.getElementById('endPartyBtn').onclick = () => {
            socket.emit('stop-party', currentRoomId);
            // Reload host to clear state completely
            location.reload();
        };

        document.getElementById('leavePartyBtn').onclick = () => {
            
            resetJoinUI();
            if (socket) socket.disconnect();
            
            // Restore controls
            currentRoomId = null;
            isHost = false;
            updateControlsState();

            // Hide modals
            partyModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            
            // Clean URL
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('join');
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);
            
            // Reset modal state
            resetModal();
            
            showInternalToast("Left party. You have control.");
        };

        function startHostHeartbeat() {
            stopHostHeartbeat();
            if(isHost) {
                hostSyncInterval = setInterval(() => {
                    if(!moviePlayer.paused && !isBuffering) {
                        socket.emit('sync-video', { roomId: currentRoomId, state: 'play', time: moviePlayer.currentTime });
                    }
                }, 2000);
            }
        }

        function stopHostHeartbeat() {
            if(hostSyncInterval) {
                clearInterval(hostSyncInterval);
                hostSyncInterval = null;
            }
        }

        moviePlayer.addEventListener('play', () => {
            if(isHost) {
                socket.emit('sync-video', { roomId: currentRoomId, state: 'play', time: moviePlayer.currentTime });
                startHostHeartbeat();
            }
        });
        moviePlayer.addEventListener('pause', () => {
            playPauseIcon.classList.remove('bi-pause-fill');
            playPauseIcon.classList.add('bi-play-fill');

            if(isHost && moviePlayer.readyState >= 3) {
                stopHostHeartbeat();
                socket.emit('sync-video', { roomId: currentRoomId, state: 'pause', time: moviePlayer.currentTime });
            }
        });
        moviePlayer.addEventListener('seeking', () => {
            if(isHost) socket.emit('sync-video', { roomId: currentRoomId, state: 'seek', time: moviePlayer.currentTime });
        });


window.addEventListener('load', () => {
    const params = new URLSearchParams(window.location.search);

    const code = params.get('code') || params.get('join');
    const name = params.get('name');

    if (code) {
        document.getElementById('joinCode').value = code.toUpperCase();
        if (name) {
            document.getElementById('joinName').value = decodeURIComponent(name);
        }

        partyToggleBtn.click();
        document.getElementById('chooseJoin').click();

        setTimeout(() => {
            document.getElementById('startJoinBtn').click();
        }, 300);
    } else {
        fetchMovieSource();
    }
});


        // --- CORE VIDEO PLAYER LOGIC ---

        const CACHE_KEY = 'thirai_continue_watching';

        function saveToContinueWatching(movie) {
            let history = JSON.parse(localStorage.getItem(CACHE_KEY)) || [];
            history = history.filter(item => item.url !== movie.url);
            history.unshift(movie);
            if (history.length > 20) history.pop();
            localStorage.setItem(CACHE_KEY, JSON.stringify(history));
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            seconds = Math.floor(seconds);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            if (hours > 0) {
                return `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
            } else {
                return `${pad(minutes)}:${pad(remainingSeconds)}`;
            }
        }

        function showControls() {
            customControlsOverlay.classList.add('visible');
            clearTimeout(controlsTimeout);
            if (!moviePlayer.paused && !moviePlayer.ended) {
                controlsTimeout = setTimeout(() => {
                    customControlsOverlay.classList.remove('visible');
                }, FADE_TIMEOUT_SECONDS * 1000);
            }
        }

        function hideControls() {
            customControlsOverlay.classList.remove('visible');
            clearTimeout(controlsTimeout);
        }

        function toggleControls() {
            if (customControlsOverlay.classList.contains('visible')) {
                hideControls();
            } else {
                showControls();
            }
        }

        moviePlayer.oncontextmenu = (e) => e.preventDefault();

        moviePlayer.addEventListener('loadedmetadata', () => {
            if (moviePlayer.paused || moviePlayer.ended || moviePlayer.currentTime === 0) {
                showControls();
            }
            if (moviePlayer.readyState < 3) {
                playPauseIcon.style.display = 'none';
                loadingSpinner.style.display = 'block';
            }
            if (movieKey) {
                const savedTime = localStorage.getItem(movieKey);
                if (savedTime && !currentRoomId) {
                    moviePlayer.currentTime = parseFloat(savedTime);
                }
            }
        });

        moviePlayer.addEventListener('timeupdate', () => {
            updateProgressBar();
            if (movieKey && !moviePlayer.ended && moviePlayer.currentTime > 0) {
                localStorage.setItem(movieKey, moviePlayer.currentTime.toString());
            }
        });

        videoPlayerWrapper.addEventListener('click', (event) => {
            const currentTime = new Date().getTime();
            const clickedOnControl = event.target.closest('.control-button') || 
                                     event.target.closest('.top-button') || 
                                     event.target.closest('.progress-bar-container') || 
                                     event.target.closest('.movie-title-display') ||
                                     event.target.closest('.volume-container') ||
                                     event.target.closest('#partyModal') ||
                                     event.target.closest('#partyEndedModal') ||
                                     event.target.closest('.time-display');

            if (!clickedOnControl && (currentTime - lastTapTime > DOUBLE_TAP_THRESHOLD_MS)) {
                toggleControls();
            }
        });

        playPauseButton.addEventListener('click', () => {
            if (moviePlayer.paused || moviePlayer.ended) {
                moviePlayer.play();
            } else {
                moviePlayer.pause();
            }
            showControls();
        });

        rewindButton.addEventListener('click', () => {
            if (!rewindButton.disabled) {
                moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                showControls();
            }
        });

        forwardButton.addEventListener('click', () => {
            if (!forwardButton.disabled) {
                moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                showControls();
            }
        });

        function updateVolumeIcon(volume) {
            volumeIcon.className = '';
            if (volume === 0 || moviePlayer.muted) {
                volumeIcon.classList.add('bi', 'bi-volume-mute-fill');
            } else if (volume < 0.5) {
                volumeIcon.classList.add('bi', 'bi-volume-down-fill');
            } else {
                volumeIcon.classList.add('bi', 'bi-volume-up-fill');
            }
        }

        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            moviePlayer.volume = volume;
            moviePlayer.muted = volume === 0;
            updateVolumeIcon(volume);
            showControls();
        });

        volumeButton.addEventListener('click', () => {
            if (moviePlayer.muted || moviePlayer.volume === 0) {
                moviePlayer.muted = false;
                moviePlayer.volume = lastVolume || 1;
                volumeSlider.value = lastVolume || 1;
            } else {
                lastVolume = moviePlayer.volume;
                moviePlayer.muted = true;
                moviePlayer.volume = 0;
                volumeSlider.value = 0;
            }
            updateVolumeIcon(moviePlayer.volume);
            showControls();
        });

        moviePlayer.addEventListener('waiting', () => {
            isBuffering = true;
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';
            showControls();
            if(!isHost && currentRoomId) lobbyStatus.textContent = "Buffering...";
            
            if(isHost && currentRoomId) {
                socket.emit('sync-video', { roomId: currentRoomId, state: 'buffering', time: moviePlayer.currentTime });
            }
        });

        moviePlayer.addEventListener('playing', () => {
            isBuffering = false;
            loadingSpinner.style.display = 'none';
            playPauseIcon.style.display = 'block';
            playPauseIcon.classList.remove('bi-play-fill');
            playPauseIcon.classList.add('bi-pause-fill');
            if(!isHost && currentRoomId) lobbyStatus.textContent = "Playing Now";
        });

        moviePlayer.addEventListener('canplay', () => {
            if (loadingSpinner.style.display === 'block') {
                loadingSpinner.style.display = 'none';
                playPauseIcon.style.display = 'block';
            }
            
            // FIX: Only auto-play if the host's reported state is actually 'play'
            if (currentRoomId && !isHost && desiredPartyState === 'play' && moviePlayer.paused) {
                moviePlayer.play().catch(() => {});
            } else if (currentRoomId && !isHost && desiredPartyState !== 'play') {
                moviePlayer.pause();
            }
            updateProgressBar();
        });

        function updateProgressBar() {
            if (!isNaN(moviePlayer.duration) && moviePlayer.duration > 0) {
                const progress = (moviePlayer.currentTime / moviePlayer.duration) * 100;
                progressBar.style.width = `${progress}%`;
                progressBarHandle.style.left = `${progress}%`;
                
                const cur = formatTime(moviePlayer.currentTime);
                const tot = formatTime(moviePlayer.duration);
                const rem = formatTime(moviePlayer.duration - moviePlayer.currentTime);
                
                if(timeFormatMode === 0) timeDisplay.textContent = `-${rem}`;
                else timeDisplay.textContent = `${cur} / ${tot}`;
            } else {
                timeDisplay.textContent = "00:00 / 00:00";
            }
        }

        progressBarContainer.addEventListener('mousedown', (e) => {
            if (moviePlayer.readyState >= 2 && (!currentRoomId || isHost)) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e);
                showControls();
            }
        });

        progressBarContainer.addEventListener('touchstart', (e) => {
            if (moviePlayer.readyState >= 2 && (!currentRoomId || isHost)) {
                isDraggingProgressBar = true;
                progressBarContainer.classList.add('dragging');
                updateSeek(e.touches[0]);
                showControls();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingProgressBar) updateSeek(e);
        });

        document.addEventListener('touchmove', (e) => {
            if (isDraggingProgressBar) updateSeek(e.touches[0]);
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
            }
        });

        document.addEventListener('touchend', () => {
            if (isDraggingProgressBar) {
                isDraggingProgressBar = false;
                progressBarContainer.classList.remove('dragging');
            }
        });

        function updateSeek(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            let clientX = e.clientX || e.pageX;
            clientX = Math.max(rect.left, Math.min(clientX, rect.right));
            const clickX = clientX - rect.left;
            const percent = clickX / rect.width;
            if (!isNaN(moviePlayer.duration)) {
                moviePlayer.currentTime = moviePlayer.duration * percent;
            }
            updateProgressBar();
        }

        backButton.addEventListener('click', () => {
            // ALWAYS redirect to root of website
            window.location.href = '/';
        });

        fullscreenButton.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                if (videoPlayerWrapper.requestFullscreen) {
                    videoPlayerWrapper.requestFullscreen();
                } else if (videoPlayerWrapper.webkitRequestFullscreen) {
                    videoPlayerWrapper.webkitRequestFullscreen();
                }
            }
            showControls();
        });

        magnificationButton.addEventListener('click', () => {
            switch (zoomLevel) {
                case 1:
                    moviePlayer.style.transform = 'scale(0.9)';
                    magnificationIcon.classList.remove('bi-zoom-in', 'bi-search');
                    magnificationIcon.classList.add('bi-zoom-out');
                    zoomLevel = 0;
                    break;
                case 0:
                    moviePlayer.style.transform = 'scale(1.2)';
                    magnificationIcon.classList.remove('bi-zoom-out');
                    magnificationIcon.classList.add('bi-search');
                    zoomLevel = 2;
                    break;
                case 2:
                    moviePlayer.style.transform = 'scale(1)';
                    magnificationIcon.classList.remove('bi-search');
                    magnificationIcon.classList.add('bi-zoom-in');
                    zoomLevel = 1;
                    break;
            }
            showControls();
        });

        document.addEventListener('touchend', (event) => {
            const clickedOnControl = event.target.closest('.control-button') ||
                                     event.target.closest('.top-button') ||
                                     event.target.closest('.progress-bar-container') ||
                                     event.target.closest('.movie-title-display') ||
                                     event.target.closest('.volume-container') ||
                                     event.target.closest('#partyModal') ||
                                     event.target.closest('.time-display');

            if (clickedOnControl) return;

            const currentTime = new Date().getTime();
            const tapX = event.changedTouches[0].clientX;

            if (currentTime - lastTapTime < DOUBLE_TAP_THRESHOLD_MS) {
                if(currentRoomId && !isHost) return;
                const videoWidth = videoPlayerWrapper.offsetWidth;
                if (tapX < videoWidth / 2) {
                    moviePlayer.currentTime = Math.max(0, moviePlayer.currentTime - SEEK_TIME);
                } else {
                    moviePlayer.currentTime = Math.min(moviePlayer.duration, moviePlayer.currentTime + SEEK_TIME);
                }
                lastTapTime = 0;
                showControls();
            } else {
                lastTapTime = currentTime;
                toggleControls();
            }
        });
        
        async function fetchMovieSource() {
            playPauseIcon.style.display = 'none';
            loadingSpinner.style.display = 'block';

            const urlParams = new URLSearchParams(window.location.search);
            const filmCode = urlParams.get('film');
            let movieUrl = urlParams.get('url');

            if (filmCode) {
                movieUrl = `https://einthusan.tv/movie/watch/${filmCode}/?lang=tamil`;
            }
            
            if (movieUrl) {
                try {
                    const response = await fetch(`https://api.thirai.me/watch?url=${encodeURIComponent(movieUrl)}`);
                    const data = await response.json();
                    
                    if (data && data.video_url) {
                        moviePlayer.src = data.video_url;
                        moviePlayer.load();
                        downloadButton.href = data.video_url;
                        downloadButton.style.display = 'flex';
                        movieTitleDisplay.textContent = data.title;
                        document.title = data.title;
                        
                        movieMeta = {
                            title: data.title,
                            img: data.img_url || 'https://via.placeholder.com/400x600?text=No+Image'
                        };

                        // ALWAYS USE THIS SPECIFIC CACHE FORMAT
                        const cacheUrl = `./watch?url=${encodeURIComponent(movieUrl)}&title=${encodeURIComponent(data.title)}`;
                        saveToContinueWatching({
                            title: data.title,
                            img: data.img_url || 'https://via.placeholder.com/400x600?text=No+Image', 
                            url: cacheUrl
                        });
                        
                        movieKey = `movie_progress_${data.title}`;
                        const savedTime = localStorage.getItem(movieKey);
                        if (savedTime && !currentRoomId) {
                            moviePlayer.currentTime = parseFloat(savedTime);
                        }
                    }
                } catch (error) {
                    console.log(error);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', showControls);
    </script>

</body>
</html>
